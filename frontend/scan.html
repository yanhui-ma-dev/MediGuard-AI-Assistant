<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scan Medicine - MediGuard</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        /* 1. Global Layout & Reset */
        body { 
            margin: 0; padding: 0; background: #000; color: white; 
            font-family: -apple-system, sans-serif; overflow: hidden; height: 100vh;
            display: flex; flex-direction: column;
        }
        
        #reader { 
            width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; z-index: 1;
        }

        /* 2. Overlay Interface */
        .header {
            position: absolute; top: 0; left: 0; right: 0; padding: 50px 20px 20px; z-index: 10;
            display: flex; align-items: center;
            background: linear-gradient(to bottom, rgba(0,0,0,0.6), transparent);
        }
        .back-btn { font-size: 28px; color: white; text-decoration: none; cursor: pointer; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }

        /* Scanning Visuals Layer */
        .scan-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 5; pointer-events: none; 
        }

        /* Viewfinder Frame (Orange Box) */
        .scan-frame {
            width: 280px; height: 180px;
            border: 8px solid #FF4500; 
            border-radius: 24px;
            box-shadow: 0 0 0 1000px rgba(0,0,0,0.5); 
            position: relative; overflow: hidden;
        }
        
        /* Animated Laser Line */
        .scan-laser {
            width: 100%; height: 2px; background: #FF3B30;
            box-shadow: 0 0 10px #FF3B30; position: absolute; top: 0;
            animation: scanMove 2s infinite ease-in-out;
        }
        @keyframes scanMove { 0% { top: 0; opacity: 0; } 50% { opacity: 1; } 100% { top: 100%; opacity: 0; } }

        /* 3. Confirmation Modal (Bottom Sheet) */
        #confirm-modal {
            display: none; position: absolute; bottom: 0; left: 0; width: 100%;
            background: white; border-radius: 24px 24px 0 0;
            padding: 30px 24px 50px; box-sizing: border-box; color: black; z-index: 20;
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .modal-title { text-align: center; font-weight: 700; margin-bottom: 20px; font-size: 18px; }

        .drug-info-box { 
            background: #F2F2F7; padding: 20px; border-radius: 16px; 
            margin-bottom: 24px; display: flex; align-items: center; gap: 16px;
        }
        
        .btn-group { display: flex; gap: 12px; }

        .btn {
            flex: 1; padding: 16px; border: none; border-radius: 16px;
            font-size: 15px; font-weight: 700; cursor: pointer;
            display: flex; justify-content: center; align-items: center;
        }

        .btn-secondary { background: #E5E5EA; color: #1C1C1E; }
        .btn-primary { background: #FF4500; color: white; }
        .btn:active { transform: scale(0.98); opacity: 0.9; }
    </style>
</head>
<body>

    <div class="header">
        <a href="index.html" class="back-btn">‚Üê</a>
    </div>

    <div id="reader"></div>

    <div class="scan-overlay">
        <div class="scan-frame">
            <div class="scan-laser"></div>
        </div>
    </div>

    <div id="confirm-modal">
        <div class="modal-title">Medicine Identified</div>
        
        <div class="drug-info-box">
            <div style="font-size: 32px;">üíä</div>
            <div style="font-size: 18px; font-weight: 600;" id="detected-drug-name">Identifying...</div>
        </div>

        <div class="btn-group">
            <button class="btn btn-secondary" onclick="saveAndExit()">Back Home</button>
            <button class="btn btn-primary" onclick="saveAndContinue()">Scan Next</button>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. Mock Database (For Demo Purposes)
        // ==========================================
        const MOCK_DB = {
            "9300705032308": "Metformin",
            "9300655059240": "Irbesartan",
            "4005900682130": "Furosemide",
            "93549004": "Allopurinol"
        };

        // App State
        let html5QrcodeScanner;
        let currentDrug = "";
        let isScanning = true;

        /**
         * Initialize the camera stream and barcode scanner
         */
        function startCamera() {
            html5QrcodeScanner = new Html5Qrcode("reader");
            
            // Optimization: Low FPS for power saving, 'environment' for back camera
            const config = { 
                fps: 10, 
                aspectRatio: window.innerWidth / window.innerHeight 
            };

            html5QrcodeScanner.start(
                { facingMode: "environment" }, 
                config, 
                onScanSuccess
            ).catch(err => {
                console.error("Camera access error:", err);
                alert("Please allow camera access to scan medicines.");
            });
        }

        /**
         * Callback: Triggered when a barcode is successfully decoded
         */
        function onScanSuccess(decodedText) {
            if (!isScanning) return;

            // Lookup drug name from Mock DB
            let drugName = MOCK_DB[decodedText];
            
            if (drugName) {
                isScanning = false;
                currentDrug = drugName;

                // Provide feedback: Pause camera and show modal
                html5QrcodeScanner.pause(); 
                
                document.getElementById('detected-drug-name').innerText = drugName;
                document.querySelector('.scan-overlay').style.display = 'none'; 
                document.getElementById('confirm-modal').style.display = 'block';
            }
        }

        /**
         * Persist scanned drug to LocalStorage
         */
        function saveToHistory(drug) {
            let history = JSON.parse(localStorage.getItem('myMedicines') || "[]");
            // Add if not already in the list
            if (!history.includes(drug)) {
                history.push(drug);
                localStorage.setItem('myMedicines', JSON.stringify(history));
            }
        }

        /**
         * Save drug and return to main dashboard
         */
        function saveAndExit() {
            saveToHistory(currentDrug);
            window.location.href = "index.html";
        }

        /**
         * Save drug and reset scanner for the next item
         */
        function saveAndContinue() {
            saveToHistory(currentDrug);

            // Reset UI components
            document.getElementById('confirm-modal').style.display = 'none';
            document.querySelector('.scan-overlay').style.display = 'flex';

            // Resume scanning stream
            html5QrcodeScanner.resume();
            isScanning = true;
        }

        // Initialize camera when page loads
        window.onload = startCamera;
    </script>
</body>
</html>